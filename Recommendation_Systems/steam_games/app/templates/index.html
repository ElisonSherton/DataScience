{% extends "material/base.html" %}
{% import "material/utils.html" as util %}
{% import "material/wtf.html" as wtf %}

{% block styles %}
{{super()}}
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
{% endblock %}
{% block scripts %}
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    var gamesAutocomplete = JSON.parse('{{games_autocomplete | tojson }}')
    var allTags = JSON.parse('{{all_tags | tojson }}')
  </script>
  <script>

  let selectedGame = null;
  let embedding = null;

  function clearCheckboxTags() {
      const _ = [].slice.call(document.getElementsByClassName('filled-in')).map(function(e) { e.removeAttribute('checked') })
  }

  function updateCollection(data){
    updateRelated(data);
    clearCheckboxTags();
    const tagEl = document.getElementById('tags');
    tagEl.innerHTML = "";
    data['tags'].forEach(function(tag){
      tagEl.innerHTML += '<a class="waves-effect waves-light btn-small" style="margin-bottom: 5px; margin-right: 5px;" id="'+tag+'tag" onclick="removeTag(\''+tag+'\')">'+tag+'</a>'
      document.getElementById(tag+'CheckboxTag').setAttribute('checked', 'checked')
    });
  }

  function updateRelated(data){
    document.getElementById('recGamesContainer').classList.remove('hide');
    const tableEl = document.getElementById('recGames');
    const tbody = tableEl.children[1];
    tbody.innerHTML = "";
    data['related'].forEach(function(game){
      tbody.innerHTML += '<tr><td>'+game[0]+'</td><td>'+game[1]+'</td>'
    });
  }

  function getRecommendations(game){
    selectedGame = game;
    $.ajax({
      url: '/recommendation',
      type: 'POST',
      contentType: 'application/json; charset=utf-8',
      data: JSON.stringify({'game':game}),
      })
      .done(function(result){
          updateCollection(result);
          embedding = result['embedding'];
      })
  }

  function updateRecommendation(tag, modification) {

    $.ajax({
      url: '/modify-embedding',
      type: 'POST',
      contentType: 'application/json; charset=utf-8',
      data: JSON.stringify({
        'game':selectedGame,
        'tag': tag,
        'modification': modification,
        'embedding': embedding,
      }),
    })
    .done(function(result){
      updateRelated(result);
      embedding = result['embedding'];
    })

  }

  function removeTag(tag){
    updateTag(tag);
    document.getElementById(tag+'CheckboxTag').removeAttribute('checked');
    var el = document.getElementById(tag+'tag');
    el.classList.add('disabled');
  }

  function updateTag(tag) {
    const el = document.getElementById(tag+'CheckboxTag');
    if (el.hasAttribute('checked')) {
      const tagButton = document.getElementById(tag+'tag');
      document.getElementById(tag+'CheckboxTag').removeAttribute('checked');
      if (tagButton) {
        tagButton.classList.add('disabled');
      }
      updateRecommendation(tag, 'subtraction')
    } else {
      document.getElementById(tag+'CheckboxTag').setAttribute('checked', 'checked');
      updateRecommendation(tag, 'addition')
    }
  }

  const ac = document.querySelector('.autocomplete');
  var instance = M.Autocomplete.init(ac, {
    minLength: 3,
    data: gamesAutocomplete,
    onAutocomplete: getRecommendations
  });

  clearCheckboxTags();

  // parallax init, only works when both inits are used.
  $(document).ready(function(){
    console.log($('.parallax'))
    $('.parallax').parallax();
  });
  document.addEventListener('DOMContentLoaded', function() {
    const elems = document.querySelectorAll('.parallax');
    const _ = M.Parallax.init(elems);
  });


  </script>
{{super()}}
{% endblock %}

{% block content %}

  <nav>
    <div class="nav-wrapper">
      <a class="brand-logo center">Steam Game Recommender</a>
    </div>
  </nav>
  <div class="parallax-container">
    <div class="parallax">
      <img src="static/images/parallax.jpg">
    </div>
  </div>


  {{ container() }}
  <div class="row">
    <div class="col s12">
      <div class="row">
        <div class="input-field col s12">
          <i class="material-icons prefix">textsms</i>
          <input type="text" id="autocomplete-input" class="autocomplete">
          <label for="autocomplete-input">Enter a Game</label>
        </div>
      </div>
    </div>
  </div>
  {{ enddiv() }}
  <div class="container">
    <div class="row hide" id="recGamesContainer">
      <h3>Similar Games</h3>
      <table class="highlight" id="recGames">
        <thead>
        <tr>
          <th>Game</th>
          <th>Similarity</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
    <h4>Modify Recommendations</h4>
    <h5>Tags</h5>
    <div class="row">
      <div id="tags">
      </div>
      <table class="highlight" id="tagTable">
        <tbody>
        {% for i in range(0, all_tags|length, 5) %}
        <tr>
          <td>
            <label>
              <input type="checkbox" class="filled-in" id="{{all_tags[i]}}CheckboxTag" checked="checked" onclick="updateTag('{{all_tags[i]}}')"/>
              <span>{{ all_tags[i] }}</span>
            </label>
          </td>
          <td>
            <label>
              <input type="checkbox" class="filled-in" id="{{all_tags[i+1]}}CheckboxTag" checked="checked" onclick="updateTag('{{all_tags[i+1]}}')"/>
              <span>{{ all_tags[i+1] }}</span>
            </label>
          </td>
          <td>
            <label>
              <input type="checkbox" class="filled-in" id="{{all_tags[i+2]}}CheckboxTag" checked="checked" onclick="updateTag('{{all_tags[i+2]}}')"/>
              <span>{{ all_tags[i+2] }}</span>
            </label>
          </td>
          {% if all_tags[i+3] %}
            <td>
              <label>
                <input type="checkbox" class="filled-in" id="{{all_tags[i+3]}}CheckboxTag" checked="checked" onclick="updateTag('{{all_tags[i+3]}}')"/>
                <span>{{ all_tags[i+3] }}</span>
              </label>
            </td>
          {% endif %}
          {% if all_tags[i+4] %}
            <td>
              <label onclick="updateTag('{{all_tags[i+4]}}')">
                <input type="checkbox" class="filled-in" id="{{all_tags[i+4]}}CheckboxTag" checked="checked"/>
                <span>{{ all_tags[i+4] }}</span>
              </label>
            </td>
          {% endif %}
        </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}